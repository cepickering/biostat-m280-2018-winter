---
title: 'BIOSTAT 203B: Homework 4'
author: "Chad Pickering"
date: "3/16/2018"
output: html_document
---

#### The following code connects to spark, the data, etc.

```{r, warning=FALSE, message=FALSE}
library(sparklyr)
library(dplyr)
library(ggplot2)
library(lubridate)
Sys.setenv(SPARK_HOME="/usr/lib/spark")
config <- spark_config()
sc <- spark_connect(master = "yarn-client", config = config)
flights_tbl <- tbl(sc, 'flights')
airports_tbl <- tbl(sc, 'airports')
flights_tbl %>% print(width = Inf) %>% head(3) ## head of the data - delete later
```

### 1. Map the top 10 busiest airports (in 1995). Size of dots should reflect the number of flights through that destination.

#### "Busiest" is defined as the sum of flights arriving and departing a particular airport per unit time.  

Chicago/O'Hare, Dallas/Ft. Worth, Atlanta, and LAX were the top 4 busiest U.S. airports in 1995 according to our metric.  

```{r}
origin_tbl <- flights_tbl %>%
  filter(year == 1995) %>%
  group_by(origin) %>%
  count() %>%
  arrange(desc(n)) %>%
  collect()

dest_tbl <- flights_tbl %>%
  filter(year == 1995) %>%
  group_by(dest) %>%
  count() %>% 
  arrange(desc(n)) %>%
  collect()

top_10_busy <- merge(origin_tbl, dest_tbl, by.x="origin", by.y="dest") %>%
  mutate(total = n.x + n.y) %>%
  arrange(desc(total)) %>%
  rename(airport = origin) %>%
  select(airport, total) %>%
  collect() %>%
  head(10)

top_10_airports <- airports_tbl %>% 
  filter(faa %in% top_10_busy$airport) %>%
  select(faa, lon, lat)

top_10_final_tbl <- merge(top_10_busy, 
                          top_10_airports, by.x="airport", by.y="faa")
top_10_final_tbl$lon <- as.numeric(as.character(top_10_final_tbl$lon))
top_10_final_tbl$lat <- as.numeric(as.character(top_10_final_tbl$lat))

usa <- map_data("usa")
ggplot() + 
  geom_polygon(data = usa, aes(x=long, y = lat, group = group), 
               fill = "aliceblue", color = "grey70") + 
  coord_fixed(1.3) +
  geom_point(data = top_10_final_tbl, 
             mapping = aes(x = lon, y = lat, color = airport, size = total)) +
  labs(title = "Top 10 Busiest U.S. Airports in 1995",
       subtitle = "Sum of Arrival and Departure Counts per Airport",
       x = "Longitude",
       y = "Latitude",
       color = "Airport",
       size = "Total Flights")
```

### 2. Map the top 10 busiest direct routes. Size of lines should reflect the number of flights through that route.  

In 1995, all of the top 10 busiest direct airline routes had their converses in the top 10 as well, as shown by the map. Destinations close to each other that are more popular pack the top 10. For example, Las Vegas to LAX and vice versa was the busiest pair.  

```{r}
routes_tbl <- flights_tbl %>%
  filter(year == 1995) %>%
  group_by(origin, dest) %>%
  count() %>%
  arrange(desc(n)) %>%
  collect() %>% 
  head(10)

top_10_routes <- airports_tbl %>% 
  filter(faa %in% routes_tbl$origin | faa %in% routes_tbl$dest) %>%
  select(faa, lon, lat)

top_10_half_lonlat <- merge(routes_tbl, top_10_routes, 
                            by.x="origin", by.y="faa")

top_10_lonlat <- merge(top_10_half_lonlat, top_10_routes, 
                       by.x="dest", by.y="faa") 

top_10_lonlat$lon.x <- as.numeric(as.character(top_10_lonlat$lon.x))
top_10_lonlat$lat.x <- as.numeric(as.character(top_10_lonlat$lat.x))
top_10_lonlat$lon.y <- as.numeric(as.character(top_10_lonlat$lon.y))
top_10_lonlat$lat.y <- as.numeric(as.character(top_10_lonlat$lat.y))

ggplot() + 
  geom_polygon(data = usa, aes(x = long, y = lat, group = group), 
               fill = "aliceblue", color = "grey70") + 
  coord_fixed(1.3) +
  geom_curve(data = top_10_lonlat, 
             aes(x = lon.x, y = lat.x, 
                 xend = lon.y, yend = lat.y, 
                 col = dest, size = n),
                 alpha = 0.7) + 
  geom_point(data = top_10_lonlat, 
            aes(x = lon.x, y = lat.x), size = 0.5) +   
  labs(title = "Top 10 Busiest Airline Routes in 1995",
       x = "Longitude",
       y = "Latitude",
       color = "Destination",
       size = "Number of Flights") 
```

### 3a. Reproduce the LAX time series plot. Visualize and explain some prominent features you observe. For example, what happened at points 1-5?

#### The reproduction:  

```{r}
df_3a <- flights_tbl %>%
  filter(year > 1997) %>%
  filter(origin == "LAX" | dest == "LAX") %>%
  group_by(year, month, dayofmonth) %>%
  arrange(year, month, dayofmonth) %>%
  count() %>%
  collect()
  
df_3a$date <- as.Date(paste(df_3a$year, df_3a$month, df_3a$dayofmonth, 
                           sep = "-"), "%Y-%m-%d")
df_3a %>%
  ggplot() +
    geom_line(mapping = aes(x = date, y = n)) +
    coord_fixed(1.3) + 
    labs(title = "LAX Air Traffic")
```

#### Prominent feature #1: 

The 9/11 attacks on September 11, 2001 greatly reduced the number of planes flying in and out of LAX. However, the drop-off is not completely sudden; it takes a few weeks to stabilize again.  

```{r, warning=FALSE, message=FALSE}
df_3a %>%
  ggplot() +
    geom_line(mapping = aes(x = date, y = n)) +
    coord_fixed(0.6) + 
    xlim(mdy("1/1/2001"), mdy("12/31/2002")) +
    labs(title = "LAX Air Traffic",
         subtitle = "January 2001 - December 2002",
         x = "Date",
         y = "Number of Flights Per Day (Incoming + Outgoing)")
```

#### Prominent features #2 and #3:

Prominent feature #2 is the dip at the end of November, likely Thanksgiving - air traffic decreases because of holiday closures and activities. Prominent feauture #3 is the dip at the beginning of July - Independence Day - much for the same reasons noted above.  

```{r, warning=FALSE, message=FALSE}
df_3a %>%
  ggplot() +
    geom_line(mapping = aes(x = date, y = n)) +
    coord_fixed(0.3) + 
    xlim(mdy("1/1/2004"), mdy("12/31/2004")) +
    labs(title = "LAX Air Traffic",
         subtitle = "January 2004 - December 2004",
         x = "Date",
         y = "Number of Flights Per Day (Incoming + Outgoing)")
```

#### Prominent feature #4: 

The Great Recession began in 2007, and the subtle drop at the beginning of 2008 may be because airports across the country implemented new policies to reduce the number of aircrafts in operation with the hopes of decreasing cost. A larger dip happens in summer 2008 after a small rebound. 

```{r, warning=FALSE, message=FALSE}
df_3a %>%
  ggplot() +
    geom_line(mapping = aes(x = date, y = n)) +
    coord_fixed(0.3) + 
    xlim(mdy("7/1/2007"), mdy("6/30/2008")) +
    labs(title = "LAX Air Traffic",
         subtitle = "July 2007 - June 2008",
         x = "Date",
         y = "Number of Flights Per Day (Incoming + Outgoing)")
```

#### Prominent feature #5: 

It seems like there was a policy change that took effect on January 1, 2001 that increased the number of aircraft in operation. This trend remains constant throughout 2001 until the 9/11 attacks.  

```{r, warning=FALSE, message=FALSE}
df_3a %>%
  ggplot() +
    geom_line(mapping = aes(x = date, y = n)) +
    coord_fixed(0.3) + 
    xlim(mdy("7/1/2000"), mdy("6/30/2001")) +
    labs(title = "LAX Air Traffic",
         subtitle = "July 2000 - June 2001",
         x = "Date",
         y = "Number of Flights Per Day (Incoming + Outgoing)")
```

### 3b. Visualize and explain seasonal effects.  

```{r}
df_3b <- flights_tbl %>%
  filter(origin == "LAX" | dest == "LAX") %>%
  group_by(year, month, dayofmonth) %>%
  arrange(year, month, dayofmonth) %>%
  count() %>%
  collect()
  
df_3a$date <- as.Date(paste(df_3a$year, df_3a$month, df_3a$dayofmonth, 
                           sep = "-"), "%Y-%m-%d")
```










